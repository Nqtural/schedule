<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="#4789c6" />
    <title>TC-stenungsund</title>

    <link rel="stylesheet" href="./new-css/variables.css" />
    <link rel="stylesheet" href="./new-css/typography.css" />
    <link rel="stylesheet" href="./new-css/styles.css" />
    <link rel="stylesheet" href="./new-css/pages/index.css" />

    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="/resources/favicon/apple-touch-icon.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="/resources/favicon/favicon-32x32.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="16x16"
      href="/resources/favicon/favicon-16x16.png"
    />
    <link rel="manifest" href="./resources/favicon/site.webmanifest" />

    <!-- Lit-component-library -->
    <script
      type="module"
      src="https://unpkg.com/lit-component-library/dist/lit-component-library.mjs"
    ></script>

    <!-- Custom Lit components -->
    <script type="module" src="./components/dist/index.js"></script>
  </head>
  <body>
    <header>
      <navbar-component></navbar-component>

      <h1>Planering</h1>
      <form onsubmit="return false">
        <label for="group-combobox-input">Grupp</label>
        <combobox-component
          id="group-combobox"
          placeholder="Grupp"
        ></combobox-component>
        <label for="week-combobox-input">Vecka</label>
        <combobox-component
          id="week-combobox"
          placeholder="Vecka"
        ></combobox-component>
      </form>
    </header>

    <main id="groups">
      <!-- Year 4 -->
      <section>
        <h2>23Te4i</h2>

        <schedule-preview-component
          scheduleName="moimob3-23te4i"
        ></schedule-preview-component>
      </section>

      <!-- Year 3 -->
      <section>
        <h2>21Tei</h2>

        <schedule-preview-component
          scheduleName="weuweb02-21tei"
        ></schedule-preview-component>

        <schedule-preview-component
          scheduleName="prrprr01-21tei"
        ></schedule-preview-component>
      </section>

      <!-- Year 2 -->
      <section>
        <h2>22Tei</h2>

        <schedule-preview-component
          scheduleName="weuweb01-22tei"
        ></schedule-preview-component>

        <schedule-preview-component
          scheduleName="daodac0-22tei"
        ></schedule-preview-component>
      </section>

      <!-- Ind -->
      <section>
        <h2>Individuellt Val</h2>

        <schedule-preview-component
          scheduleName="weuweb01-ind"
        ></schedule-preview-component>

        <schedule-preview-component
          scheduleName="nainae0-ind"
        ></schedule-preview-component>

        <schedule-preview-component
          scheduleName="fotfot01-ind"
        ></schedule-preview-component>
      </section>
    </main>

    <aside>
      <h2>Aktuella uppgifter</h2>
      <active-assignments-component></active-assignments-component>
    </aside>

    <!-- Get UrlParams -->
    <script>
      const urlParams = new URLSearchParams(window.location.search);
    </script>

    <!-- Get the week number for a date -->
    <script>
      function getWeekNumber(date = new Date()) {
        date.setHours(0, 0, 0, 0);
        // Thursday in current week decides the year.
        date.setDate(date.getDate() + 3 - ((date.getDay() + 6) % 7));
        // January 4 is always in week 1.
        var week1 = new Date(date.getFullYear(), 0, 4);
        // Adjust to Thursday in week 1 and count number of weeks from date to week1.
        return (
          1 +
          Math.round(
            ((date.getTime() - week1.getTime()) / 86400000 -
              3 +
              ((week1.getDay() + 6) % 7)) /
              7
          )
        );
      }
    </script>

    <!-- Set values in lit combobox components -->
    <script>
      groups = [{ name: "Alla", value: "All" }];
      document
        .getElementById("groups")
        .querySelectorAll("section h2:first-child")
        .forEach((h2) => {
          groups.push({
            name: h2.innerText,
            value: h2.innerText.toLowerCase(),
          });
        });

      document
        .getElementById("group-combobox")
        .setAttribute("options", JSON.stringify(groups));

      weeks = [
        { name: "Nuvarande", value: "current" },
        { name: "1", value: "option 1" },
        { name: "2", value: "option 2" },
      ];
      document
        .getElementById("week-combobox")
        .setAttribute("options", JSON.stringify(weeks));
    </script>

    <!-- Set courses in active assignment component -->
    <script>
      updateActiveCourses();

      function updateActiveCourses() {
        activeCourses = [];
        document
          .querySelectorAll(
            ':not([selected="false"]) schedule-preview-component'
          )
          .forEach((e) => {
            activeCourses.push(e.getAttribute("scheduleName"));
          });

        document
          .querySelector("active-assignments-component")
          .setAttribute("courses", JSON.stringify(activeCourses));
      }
    </script>

    <!-- Set week number in lit components -->
    <script>
      let week = urlParams.get("week");

      if (!week) week = getWeekNumber();
      document.getElementById("week-combobox").setAttribute("value", week);

      updateWeek();

      document.addEventListener(
        "DOMContentLoaded",
        function () {
          document
            .getElementById("week-combobox")
            ?.shadowRoot?.getElementById("week-combobox-input")
            ?.addEventListener("change", (e) => {
              week = e.target.value;
              updateWeek();
            });
        },
        false
      );

      function updateWeek() {
        document.getElementById("week-combobox").value = week;

        document.querySelectorAll("schedule-preview-component").forEach((e) => {
          e.setAttribute("week", week);
        });

        document
          .querySelectorAll("active-assignments-component")
          .forEach((e) => {
            e.setAttribute("week", week);
          });
      }
    </script>

    <!-- Only show selected groups -->
    <script>
      let group = urlParams.get("group");

      if (!group) group = "Alla";
      document.getElementById("group-combobox").setAttribute("value", group);

      showOnlySelectedGroups();

      document.addEventListener(
        "DOMContentLoaded",
        function () {
          document
            .getElementById("group-combobox")
            ?.shadowRoot?.getElementById("group-combobox-input")
            ?.addEventListener("change", (e) => {
              group = e.target.value;
              showOnlySelectedGroups();
            });
        },
        false
      );

      function showOnlySelectedGroups() {
        const selectedGroup = document
          .getElementById("group-combobox")
          .getAttribute("value");

        if (
          selectedGroup.toLowerCase() === "all" ||
          selectedGroup.toLowerCase() === "alla"
        )
          return;
        document
          .getElementById("groups")
          .querySelectorAll("section")
          .forEach((section) => {
            if (
              section
                .querySelector("h2:first-child")
                .innerText.toLowerCase() === selectedGroup.toLowerCase()
            ) {
              section.style.display = "flex";
              section.setAttribute("selected", "true");
            } else {
              section.style.display = "none";
              section.setAttribute("selected", "false");
            }
          });

        // Code for if we want to show only active assignments by groups
        // document
        //   .getElementById("active-assignments")
        //   .querySelectorAll("section")
        //   .forEach((section) => {
        //     if (
        //       section
        //         .querySelector("h2:first-child")
        //         .innerText.toLowerCase() === selectedGroup.toLowerCase()
        //     )
        //       section.style.display = "block";
        //     else section.style.display = "none";
        //   });

        updateActiveCourses();
      }
    </script>
  </body>
</html>
